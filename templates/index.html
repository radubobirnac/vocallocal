<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocalLocal - Speech to Text</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            padding: 20px 0;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4e5afc;
        }
        .subtitle {
            color: #666;
            margin-top: 0.5rem;
        }
        .mode-switch {
            margin-bottom: 1.5rem;
        }
        .recorder-container {
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        .recordButton {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background-color: #4e5afc;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }
        .recordButton:hover {
            background-color: #3949db;
            transform: scale(1.05);
        }
        .recordButton i {
            font-size: 2rem;
        }
        .recordButton.recording {
            animation: pulse 1.5s infinite;
            background-color: #dc3545;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .language-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .transcript, .translation {
            min-height: 100px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            padding: 1rem;
            background-color: #f8f9fa;
            height: 100%;
        }
        #uploadForm {
            margin-top: 1rem;
        }
        .play-btn {
            margin-left: 0.5rem;
            padding: 0.2rem 0.5rem;
        }
        
        /* Mobile-friendly button styles */
        .btn-mobile-friendly {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 70px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-mobile-friendly i {
            margin-right: 5px;
        }
        .speaker-card {
            height: 100%;
        }
        .speaker-1 .card-header {
            background-color: #e6f3ff;
        }
        .speaker-2 .card-header {
            background-color: #e6fff0;
        }
        .about-section i {
            transition: transform 0.3s ease;
        }
        .about-section button[aria-expanded="true"] i {
            transform: rotate(180deg);
        }
        .model-toggle {
            margin-bottom: 0.75rem;
        }
        .model-toggle h6 {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        .model-toggle .form-check {
            margin-right: 1.5rem;
        }
        .info-icon {
            cursor: pointer;
            color: #4e5afc;
            margin-left: 5px;
        }
        .section-divider {
            height: 2px;
            background-color: #e9ecef;
            margin: 2rem 0;
        }
        
        /* Responsive adjustments */
        @media (min-width: 992px) {
            .transcript-container {
                height: 100%;
                display: flex;
                flex-direction: column;
            }
            .transcript-card-body {
                display: flex;
                flex: 1;
            }
            .controls-column {
                padding-right: 2rem;
                border-right: 1px solid #e2e8f0;
            }
        }
        
        @media (max-width: 991px) {
            .controls-column {
                margin-bottom: 2rem;
                padding-bottom: 2rem;
                border-bottom: 1px solid #e2e8f0;
            }
            .header {
                flex-direction: column;
                align-items: center;
            }
            .logo-container {
                margin-bottom: 1rem;
                text-align: center;
            }
            .language-selector {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
                gap: 10px;
            }
        }
        
        /* Additional mobile-specific adjustments */
        @media (max-width: 576px) {
            .language-selector {
                flex-direction: column;
                align-items: center;
            }
            select.form-select-sm {
                width: 100% !important;
                margin-right: 0 !important;
                margin-bottom: 10px;
            }
            .play-btn {
                padding: 0.15rem 0.4rem;
                font-size: 0.85rem;
            }
            .btn-sm {
                padding: 0.2rem 0.5rem;
                font-size: 0.875rem;
            }
            .transcript, .translation {
                min-height: 80px;
                padding: 0.5rem;
                width: 100%;
                display: block;
                overflow-wrap: break-word;
            }
            /* Improve translation visibility on mobile */
            #basicTranslationCard {
                display: block !important;
                width: 100%;
                margin-top: 1rem;
            }
            .d-flex.justify-content-between.align-items-start {
                display: flex !important;
                width: 100%;
            }
            .d-flex.justify-content-between.align-items-start > div {
                flex: 1;
                min-width: 0;
                overflow-wrap: break-word;
                word-break: break-word;
            }
            /* Ensure proper button layout in bilingual mode for mobile */
            .card-header .d-flex.justify-content-between.align-items-center {
                flex-wrap: nowrap !important;
            }
            
            /* Make copy button appear next to play button */
            #copyTranscript1Button, 
            #copyTranscript2Button {
                display: inline-flex !important;
                margin-left: 0.25rem !important;
                min-width: 40px;
                padding: 0.25rem 0.5rem;
            }
            
            /* Make translation header and buttons display correctly */
            .translation-header {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                margin-top: 0.75rem;
                margin-bottom: 0.5rem;
            }
            
            /* Make the translation layout better on mobile */
            .translation {
                position: relative;
            }
            
            /* Make buttons more tappable on mobile */
            .btn-mobile-friendly {
                min-width: 65px !important;
                font-size: 0.9rem !important;
                padding: 0.3rem 0.5rem !important;
                margin-right: 8px !important;
                font-weight: 500 !important;
            }
            
            /* Ensure buttons in transcript rows are properly aligned */
            .d-flex.justify-content-between.align-items-start {
                align-items: center !important;
            }
            
            /* Better spacing between button and text */
            .btn-mobile-friendly span {
                margin-left: 5px !important;
                display: inline-block !important;
            }
            
            /* Make sure the play buttons have priority in the flex layout */
            .transcript div.d-flex button,
            .translation div.d-flex button {
                flex-shrink: 0 !important;
            }
        }
        
        /* Tighter spacing for card elements */
        .card-body {
            padding: 1rem;
        }
        
        /* Reduce spacing around transcript heading */
        h6.transcript-heading {
            margin-bottom: 0.5rem;
            margin-top: 0.5rem;
        }
        
        /* Make dividers between sections thinner */
        .controls-column {
            padding-bottom: 0.75rem;
        }
        
        /* Reduce space between status and button */
        #recordingStatus {
            margin-bottom: 0.5rem;
        }
        
        /* Ensure translations are properly visible on mobile */
        #basicTranslationCard .transcript {
            width: 100%;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        /* NEW CSS FIXES FOR RESPONSIVE DESIGN ISSUES */
        
        /* Improve translation visibility on mobile */
        @media (max-width: 576px) {
            #basicTranslationCard, 
            .translation-header, 
            .translation {
                display: block !important;
                width: 100%;
                margin-top: 0.5rem;
            }
            
            /* Make buttons more tappable on mobile */
            .btn-mobile-friendly {
                min-width: 40px;
                min-height: 34px;
                padding: 0.25rem 0.5rem;
                margin-left: 8px;
            }
            
            /* Ensure transcript and translation containers are always visible */
            .transcript, .translation {
                min-height: 60px;
                padding: 0.75rem;
                width: 100%;
                display: block !important;
                overflow-wrap: break-word;
                word-break: break-word;
                margin-bottom: 1rem;
            }
            
            /* Fix flex layout issues on small screens */
            .d-flex.justify-content-between.align-items-start {
                display: flex !important;
                width: 100%;
                flex-wrap: wrap;
            }
            
            /* Ensure text content takes necessary space */
            .d-flex.justify-content-between.align-items-start > div:first-child {
                flex: 1;
                min-width: 70%;
                padding-right: 8px;
            }

            /* Make play buttons more visible on mobile */
            #basicPlayTranscriptButton,
            #basicPlayTranslationButton,
            #playTranscript1Button,
            #playTranscript2Button,
            #playTranslation1Button,
            #playTranslation2Button {
                min-width: 40px;
                min-height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 0.5rem;
            }
        }

        /* Ensure translation visibility at all screen sizes */
        #basicTranslationCard .transcript,
        .translation-header,
        .translation {
            display: block;
        }
        

        /* Fix for translation elements always being visible */
        #basicTranslationCard {
            display: block;
        }

        /* Fix spacing for buttons on very small screens */
        @media (max-width: 320px) {
            .btn-mobile-friendly {
                margin-left: 4px;
                min-width: 32px;
                padding: 0.15rem 0.3rem;
            }
            
            .d-flex.justify-content-between.align-items-start {
                gap: 4px;
            }
        }

        /* Make sure content is readable in translation areas */
        .translation div:first-child, 
        .transcript div:first-child {
            word-break: break-word;
            hyphens: auto;
        }

        /* Make sure the translation copy buttons appear correctly */
        #copyTranslationMobile1Button,
        #copyTranslationMobile2Button {
            min-width: 40px;
            padding: 0.25rem 0.5rem;
            margin-left: 0.25rem;
        }

        /* Better translation headers for desktop */
        @media (min-width: 768px) {
            .translation-header {
                margin-top: 1rem;
                margin-bottom: 0.5rem;
            }
            
            .translation-header h6 {
                margin-bottom: 0;
            }
        }

        /* Better translation layout for mobile */
        @media (max-width: 767px) {
            .translation-header h6 {
                margin-bottom: 0;
            }
            
            .translation div.d-flex > div:last-child {
                display: flex;
                align-items: center;
            }
            
            #playTranslation1Button,
            #playTranslation2Button {
                margin-right: 0;
            }
        }

        /* Increase the size of the button icons */
        .btn-mobile-friendly i {
            font-size: 1rem !important;
        }

        #translation1, #translation2 {
            margin-top: 10px;
        }

        .translation div.d-flex {
            align-items: center !important;
        }

        /* Speaker 1 & 2 initial display */
        #transcript1, #transcript2 {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <div class="logo">VocalLocal</div>
                <p class="subtitle" id="appSubtitle">Accurate Multilingual Speech-to-Text Transcription</p>
            </div>
            <div class="language-selector">
                <div class="d-flex align-items-center">
                    <img src="https://img.icons8.com/ios-filled/24/000000/language.png" alt="Language" style="width: 24px; height: 24px; margin-right: 5px;" />
                    <select id="globalLanguageSelect" class="form-select form-select-sm" style="width: auto; margin-right: 15px;">
                        <!-- Will be populated with languages -->
                    </select>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="modeToggle">
                    <label class="form-check-label" for="modeToggle">Bilingual Mode</label>
                </div>
            </div>
        </div>

        <!-- MONOLINGUAL MODE -->
        <div id="basicMode" class="basic-mode">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Voice Transcription</h5>
                    <button id="basicCopyTranscriptButton" class="btn btn-sm btn-outline-secondary">Copy</button>
                </div>
                <div class="card-body transcript-card-body p-2">
                    <div class="row h-100">
                        <div class="col-lg-4 controls-column pb-2">
                            <div class="mb-3">
                                <label for="basicLanguageSelect" class="form-label">Input Language:</label>
                                <select id="basicLanguageSelect" class="form-select"></select>
                            </div>
                            
                            <div class="model-toggle mb-2">
                                <h6 class="mb-1">Model Selection</h6>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="transcriptionModel" id="basicFastModel" value="gpt-4o-mini-transcribe" checked>
                                    <label class="form-check-label" for="basicFastModel">Fast model</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="transcriptionModel" id="basicAccurateModel" value="gpt-4o-transcribe">
                                    <label class="form-check-label" for="basicAccurateModel">More accurate but slower</label>
                                </div>
                            </div>
                            
                            <div class="recorder-container">
                                <button id="basicRecordButton" class="recordButton">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <div id="basicRecordingStatus">Click to start recording</div>
                            </div>
                        </div>
                        
                        <div class="col-lg-8 transcript-container">
                            <h6 class="transcript-heading">Transcript</h6>
                            <div id="basicTranscript" class="transcript flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>Transcribed text will appear here...</div>
                                    <button id="basicPlayTranscriptButton" class="btn btn-sm btn-outline-primary btn-mobile-friendly">
                                        <i class="fas fa-play"></i> <span>Play</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Upload Audio File</h5>
                </div>
                <div class="card-body">
                    <form id="basicUploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <input class="form-control" type="file" id="basicAudioFile" accept=".wav, .mp3, .ogg, .m4a, .mp4, .webm">
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="uploadTranscriptionModel" id="basicUploadFastModel" value="gpt-4o-mini-transcribe" checked>
                                <label class="form-check-label" for="basicUploadFastModel">Fast model</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="uploadTranscriptionModel" id="basicUploadAccurateModel" value="gpt-4o-transcribe">
                                <label class="form-check-label" for="basicUploadAccurateModel">More accurate but slower</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Transcribe</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- BILINGUAL MODE -->
        <div id="bilingualMode" class="bilingual-mode" style="display: none;">
            <div class="row mb-4">
                <!-- Speaker 1 UI -->
                <div class="col-md-6 mb-4" id="speakerSection1">
                    <div class="card speaker-card speaker-1">
                        <div class="card-header">
                            <h5>Speaker 1</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="languageSelect1" class="form-label">Your Language:</label>
                                <select id="languageSelect1" class="form-select"></select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="modelSelect1" class="form-label">Transcription Quality:</label>
                                <select id="modelSelect1" class="form-select">
                                    <option value="gpt-4o-mini-transcribe">Standard (Faster)</option>
                                    <option value="gpt-4o-transcribe">Higher (Slower)</option>
                                </select>
                            </div>
                            
                            <div class="recorder-container">
                                <button id="recordButton1" class="recordButton">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <div id="recordingStatus1">Click to start recording</div>
                            </div>
                            
                            <div class="form-check audioToggle">
                                <input class="form-check-input" type="checkbox" id="enableTTS1">
                                <label class="form-check-label" for="enableTTS1">
                                    Read translations aloud
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Speaker 2 UI -->
                <div class="col-md-6 mb-4" id="speakerSection2">
                    <div class="card speaker-card speaker-2">
                        <div class="card-header">
                            <h5>Speaker 2</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="languageSelect2" class="form-label">Your Language:</label>
                                <select id="languageSelect2" class="form-select"></select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="modelSelect2" class="form-label">Transcription Quality:</label>
                                <select id="modelSelect2" class="form-select">
                                    <option value="gpt-4o-mini-transcribe">Standard (Faster)</option>
                                    <option value="gpt-4o-transcribe">Higher (Slower)</option>
                                </select>
                            </div>
                            
                            <div class="recorder-container">
                                <button id="recordButton2" class="recordButton">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <div id="recordingStatus2">Click to start recording</div>
                            </div>
                            
                            <div class="form-check audioToggle">
                                <input class="form-check-input" type="checkbox" id="enableTTS2">
                                <label class="form-check-label" for="enableTTS2">
                                    Read translations aloud
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conversation Display -->
            <div class="row conversation-display">
                <!-- Speaker 1 Output -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5>Speaker 1</h5>
                                <div>
                                    <button id="playTranscript1Button" class="btn btn-sm btn-outline-primary me-2 btn-mobile-friendly">
                                        <i class="fas fa-play"></i> <span>Play</span>
                                    </button>
                                    <button id="copyTranscript1Button" class="btn btn-sm btn-outline-secondary">Copy</button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <h6>Original:</h6>
                            <div id="transcript1" class="transcript">Your speech will appear here...</div>
                            <div class="d-flex justify-content-between align-items-center translation-header">
                                <h6>Translation:</h6>
                                <button id="copyTranslation1Button" class="btn btn-sm btn-outline-secondary d-none d-md-block">Copy</button>
                            </div>
                            <div id="translation1" class="translation">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>Translation will appear here...</div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary btn-mobile-friendly" id="playTranslation1Button">
                                            <i class="fas fa-play"></i> <span>Play</span>
                                        </button>
                                        <button id="copyTranslationMobile1Button" class="btn btn-sm btn-outline-secondary d-inline-block d-md-none">Copy</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Speaker 2 Output -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5>Speaker 2</h5>
                                <div>
                                    <button id="playTranscript2Button" class="btn btn-sm btn-outline-primary me-2 btn-mobile-friendly">
                                        <i class="fas fa-play"></i> <span>Play</span>
                                    </button>
                                    <button id="copyTranscript2Button" class="btn btn-sm btn-outline-secondary">Copy</button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <h6>Original:</h6>
                            <div id="transcript2" class="transcript">Your speech will appear here...</div>
                            <div class="d-flex justify-content-between align-items-center translation-header">
                                <h6>Translation:</h6>
                                <button id="copyTranslation2Button" class="btn btn-sm btn-outline-secondary d-none d-md-block">Copy</button>
                            </div>
                            <div id="translation2" class="translation">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>Translation will appear here...</div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary btn-mobile-friendly" id="playTranslation2Button">
                                            <i class="fas fa-play"></i> <span>Play</span>
                                        </button>
                                        <button id="copyTranslationMobile2Button" class="btn btn-sm btn-outline-secondary d-inline-block d-md-none">Copy</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-divider"></div>

        <div class="card mb-4 about-section">
            <div class="card-header">
                <button class="btn btn-link text-decoration-none p-0 w-100 text-start d-flex justify-content-between align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#aboutSection" aria-expanded="false" aria-controls="aboutSection">
                    <h5 class="mb-0">About VocalLocal</h5>
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div class="collapse" id="aboutSection">
                <div class="card-body">
                    <p>VocalLocal is a multilingual speech-to-text transcription tool designed to provide accurate transcriptions in multiple languages. Using advanced AI technology, it converts spoken language from audio recordings or microphone input into written text.</p>
                    
                    <h6>Features</h6>
                    <ul>
                        <li>Real-time transcription - Record directly from your microphone and get immediate results</li>
                        <li>File upload support - Process pre-recorded audio files in various formats</li>
                        <li>Multilingual capabilities - Support for 30+ languages with native language names</li>
                        <li>Easy copying - One-click copying of transcription results</li>
                        <li>Bilingual mode - Facilitate conversations between speakers of different languages</li>
                        <li>Text-to-speech playback - Listen to transcriptions and translations</li>
                    </ul>
                    
                    <h6>Limitations</h6>
                    <ul>
                        <li>Audio quality significantly affects transcription accuracy</li>
                        <li>Background noise may impact results</li>
                        <li>Maximum file size of 30MB per upload</li>
                        <li>Some rare languages or dialects may have lower accuracy. For more information on speech recognition accuracy measurements, see <a href="https://openai.com/index/introducing-our-next-generation-audio-models/" target="_blank">OpenAI's research on word error rates</a>.</li>
                        <li>Recordings are limited to 25 minutes maximum duration</li>
                        <li>Speaking in multiple languages at once may result in mixed results</li>
                    </ul>
                    
                    <h6>Technical Details</h6>
                    <p>VocalLocal uses OpenAI's speech recognition models to process audio. The application supports various audio formats including WAV, MP3, OGG, and M4A. The language detection feature can automatically identify the spoken language, though manually selecting the correct language may improve accuracy for certain languages.</p>
                    
                    <h6>Privacy Information</h6>
                    <p>Audio data is processed securely and is not stored permanently. Recordings are only kept temporarily during the transcription process and are deleted immediately afterward. Transcribed text remains in your browser and is not saved on our servers unless explicitly requested.</p>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <div id="status" class="alert alert-info d-none"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/4b1c7a602f.js" crossorigin="anonymous"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Check browser compatibility
            function checkBrowserCompatibility() {
                // Check for MediaRecorder API
                if (!window.MediaRecorder) {
                    showStatus('Your browser does not support audio recording. Please try a modern browser like Chrome, Firefox, Edge, or Safari.', 'danger', true);
                    document.querySelectorAll('.recordButton').forEach(btn => {
                        btn.disabled = true;
                        btn.style.opacity = 0.5;
                    });
                    document.getElementById('basicRecordingStatus').textContent = 'Recording not supported in this browser';
                    document.getElementById('recordingStatus1').textContent = 'Recording not supported in this browser';
                    document.getElementById('recordingStatus2').textContent = 'Recording not supported in this browser';
                }
                
                // Check for getUserMedia support
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showStatus('Your browser does not support microphone access. Please try a modern browser.', 'danger', true);
                    document.querySelectorAll('.recordButton').forEach(btn => {
                        btn.disabled = true;
                        btn.style.opacity = 0.5;
                    });
                    document.getElementById('basicRecordingStatus').textContent = 'Microphone access not supported';
                    document.getElementById('recordingStatus1').textContent = 'Microphone access not supported';
                    document.getElementById('recordingStatus2').textContent = 'Microphone access not supported';
                }
            }
            
            // Mode toggle functionality
            const modeToggle = document.getElementById('modeToggle');
            const basicMode = document.getElementById('basicMode');
            const bilingualMode = document.getElementById('bilingualMode');
            const appSubtitle = document.getElementById('appSubtitle');
            
            // Set default to monolingual mode
            basicMode.style.display = 'block';
            bilingualMode.style.display = 'none';
            appSubtitle.textContent = 'Accurate Multilingual Speech-to-Text Transcription';
            
            // Toggle between modes
            modeToggle.addEventListener('change', () => {
                if (modeToggle.checked) {
                    // Bilingual mode
                    basicMode.style.display = 'none';
                    bilingualMode.style.display = 'block';
                    appSubtitle.textContent = 'Bilingual Conversation Tool';
                } else {
                    // Basic mode
                    basicMode.style.display = 'block';
                    bilingualMode.style.display = 'none';
                    appSubtitle.textContent = 'Accurate Multilingual Speech-to-Text Transcription';
                }
            });
            
            // Detect device and browser
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isAndroid = /Android/.test(navigator.userAgent);
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            const isFirefox = navigator.userAgent.indexOf("Firefox") > -1;
            const isEdge = navigator.userAgent.indexOf("Edg") > -1;
            
            console.log("Device detection:", { isIOS, isAndroid, isSafari, isFirefox, isEdge });
            
            // Load languages - shared function
            function loadLanguages() {
                return fetch('/api/languages')
                    .then(response => response.json())
                    .then(languages => {
                        // Sort language names alphabetically
                        const sortedLanguages = Object.entries(languages).sort((a, b) => 
                            a[0].localeCompare(b[0])
                        );
                        
                        // Populate global language dropdown
                        populateLanguageDropdown('globalLanguageSelect', sortedLanguages, 'en');
                        
                        // Populate basic mode dropdown
                        populateLanguageDropdown('basicLanguageSelect', sortedLanguages, 'en');
                        
                        // Populate bilingual mode dropdowns
                        populateLanguageDropdown('languageSelect1', sortedLanguages, 'en');
                        populateLanguageDropdown('languageSelect2', sortedLanguages, 'es');
                        
                        return sortedLanguages;
                    })
                    .catch(error => {
                        console.error("Error loading languages:", error);
                        showStatus('Could not load language options. Please refresh the page.', 'warning', true);
                    });
            }
            
            // Helper function to populate a language dropdown
            function populateLanguageDropdown(dropdownId, languages, defaultCode, includeEmpty = false) {
                const dropdown = document.getElementById(dropdownId);
                dropdown.innerHTML = ''; // Clear existing options
                
                // Add empty option if requested
                if (includeEmpty) {
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = 'No Translation';
                    dropdown.appendChild(emptyOption);
                }
                
                // Add language options
                languages.forEach(([name, details]) => {
                    const option = document.createElement('option');
                    option.value = details.code;
                    option.textContent = `${name} (${details.native})`;
                    if (details.code === defaultCode) option.selected = true;
                    dropdown.appendChild(option);
                });
            }
            
            // Speech synthesis functionality - shared function
            function speakText(text, langCode) {
                if (!window.speechSynthesis) {
                    showStatus('Text-to-speech is not supported in your browser', 'warning');
                    return;
                }
                
                // Stop any current speech
                window.speechSynthesis.cancel();
                
                // Create a new utterance
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Set language
                utterance.lang = langCode;
                
                // Start speaking
                window.speechSynthesis.speak(utterance);
                showStatus('Playing audio...', 'info');
            }
            
            // Get supported media types based on browser/device
            function getSupportedMediaTypes() {
                const supportedTypes = [];
                
                // Check what audio formats are supported
                const mimeTypes = [
                    'audio/webm',
                    'audio/webm;codecs=opus',
                    'audio/mp4',
                    'audio/mpeg',
                    'audio/ogg',
                    'audio/ogg;codecs=opus',
                    'audio/wav'
                ];
                
                // Test each MIME type
                mimeTypes.forEach(type => {
                    if (MediaRecorder.isTypeSupported(type)) {
                        supportedTypes.push(type);
                    }
                });
                
                // Determine the best MIME type based on device/browser
                let bestType;
                
                if (isIOS || isSafari) {
                    // iOS and Safari prefer these formats
                    bestType = supportedTypes.find(t => t.includes('mp4')) ||
                               supportedTypes.find(t => t.includes('mpeg')) ||
                               supportedTypes[0];
                } else if (isAndroid) {
                    // Android typically supports these well
                    bestType = supportedTypes.find(t => t.includes('webm;codecs=opus')) ||
                               supportedTypes.find(t => t.includes('webm')) ||
                               supportedTypes.find(t => t.includes('ogg')) ||
                               supportedTypes[0];
                } else {
                    // Desktop browsers generally support these
                    bestType = supportedTypes.find(t => t.includes('webm;codecs=opus')) ||
                               supportedTypes.find(t => t.includes('webm')) ||
                               supportedTypes.find(t => t.includes('ogg')) ||
                               supportedTypes[0];
                }
                
                return { supportedTypes, bestType };
            }
            
            // Error handling for microphone issues - shared function
            function handleMicrophoneError(error) {
                if (error.name === 'NotAllowedError') {
                    showStatus('Microphone access denied. Please enable permissions in your browser settings.', 'danger', true);
                } else if (error.name === 'NotFoundError') {
                    showStatus('No microphone detected on your device.', 'warning', true);
                } else if (error.name === 'NotReadableError') {
                    showStatus('Cannot access microphone. It may be in use by another app.', 'warning', true);
                } else if (error.name === 'SecurityError') {
                    showStatus('Microphone access requires a secure connection (HTTPS).', 'danger', true);
                } else if (error.name === 'AbortError') {
                    showStatus('Microphone access was aborted. Please try again.', 'warning');
                } else {
                    showStatus('Microphone access error: ' + error.message, 'warning', true);
                }
                console.error('Microphone error:', error);
            }
            
            // Status display - shared function
            function showStatus(message, type = 'info', persistent = false) {
                const statusEl = document.getElementById('status');
                statusEl.textContent = message;
                statusEl.className = `alert alert-${type}`;
                statusEl.classList.remove('d-none');
                
                if (!persistent) {
                    setTimeout(() => {
                        statusEl.classList.add('d-none');
                    }, 3000);
                }
            }
            
            // Universal audio recording function with cross-platform support
            async function startRecording(options = {}) {
                try {
                    // Visual indication that we're requesting mic access
                    showStatus('Requesting microphone access...', 'info');
                    
                    // Get audio constraints with echo cancellation and noise suppression
                    const constraints = {
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    };
                    
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    // Get the best supported MIME type
                    const { bestType } = getSupportedMediaTypes();
                    
                    // Configure recorder
                    const recorderOptions = bestType ? { mimeType: bestType } : {};
                    const mediaRecorder = new MediaRecorder(stream, recorderOptions);
                    
                    // Setup data array
                    const audioChunks = [];
                    
                    // Data available listener
                    mediaRecorder.addEventListener('dataavailable', event => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    });
                    
                    // Start recording
                    mediaRecorder.start(100); // Get events more frequently for better responsiveness
                    showStatus('Recording started', 'success');
                    
                    // Add visual feedback for recording
                    const recordButton = options.recordButton || null;
                    if (recordButton) {
                        recordButton.classList.add('recording');
                    }
                    
                    // Log diagnostics
                    console.log("Recording started with:", {
                        mimeType: mediaRecorder.mimeType || "default",
                        deviceInfo: "Audio input device",
                        sampleRate: stream.getAudioTracks()[0].getSettings().sampleRate || "unknown"
                    });
                    
                    return {
                        mediaRecorder,
                        audioChunks,
                        stream
                    };
                } catch (error) {
                    handleMicrophoneError(error);
                    throw error; // Re-throw to let caller handle it
                }
            }
            
            // Process and send audio data
            function processAudio(audioChunks, mimeType, formData) {
                return new Promise((resolve, reject) => {
                    try {
                        // Determine best file format based on MIME type and device
                        let fileType, fileName;
                        
                        if (mimeType.includes('webm')) {
                            fileType = 'audio/webm';
                            fileName = 'recording.webm';
                        } else if (mimeType.includes('mp4')) {
                            fileType = 'audio/mp4';
                            fileName = 'recording.m4a';
                        } else if (mimeType.includes('ogg')) {
                            fileType = 'audio/ogg';
                            fileName = 'recording.ogg';
                        } else if (mimeType.includes('wav')) {
                            fileType = 'audio/wav';
                            fileName = 'recording.wav';
                        } else {
                            // Default fallback - try to pick the best format for the platform
                            if (isIOS || isSafari) {
                                fileType = 'audio/mp4';
                                fileName = 'recording.m4a';
                            } else {
                                fileType = 'audio/webm';
                                fileName = 'recording.webm';
                            }
                        }
                        
                        // Create blob with determined type
                        const audioBlob = new Blob(audioChunks, { type: fileType });
                        
                        // Validate blob
                        if (audioBlob.size === 0) {
                            reject(new Error('No audio data recorded'));
                            return;
                        }
                        
                        // Create file object
                        const audioFile = new File([audioBlob], fileName, { type: fileType });
                        
                        // Add file to form data
                        formData.append('file', audioFile);
                        
                        // Log diagnostic info
                        console.log("Audio recording info:", {
                            recordedMimeType: mimeType,
                            blobType: fileType,
                            fileName: fileName,
                            blobSize: audioBlob.size,
                            chunkCount: audioChunks.length
                        });
                        
                        resolve(formData);
                    } catch (error) {
                        console.error("Error processing audio:", error);
                        reject(error);
                    }
                });
            }
            
            // Translate text function
            async function translateText(text, targetLang) {
                try {
                    const response = await fetch('/api/translate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            text: text,
                            target_language: targetLang
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Translation failed: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return result.text;
                } catch (error) {
                    console.error('Translation error:', error);
                    showStatus('Translation failed: ' + error.message, 'danger');
                    return null;
                }
            }
            
            // Send form data to server with timeout and retry
            function sendToServer(formData, endpoint = '/api/transcribe', maxRetries = 1) {
                return new Promise(async (resolve, reject) => {
                    let attempt = 0;
                    
                    while (attempt <= maxRetries) {
                        try {
                            // Create AbortController for timeout
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout
                            
                            const response = await fetch(endpoint, {
                                method: 'POST',
                                body: formData,
                                signal: controller.signal
                            });
                            
                            // Clear timeout
                            clearTimeout(timeoutId);
                            
                            if (!response.ok) {
                                throw new Error(`Server error: ${response.status}`);
                            }
                            
                            const result = await response.json();
                            resolve(result);
                            return; // Exit the retry loop on success
                            
                        } catch (error) {
                            attempt++;
                            
                            // Log the error
                            console.error(`Attempt ${attempt} failed:`, error);
                            
                            // If it's a timeout or a network error and we have retries left
                            if ((error.name === 'AbortError' || 
                                (error.name === 'TypeError' && error.message.includes('Failed to fetch'))) && 
                                attempt <= maxRetries) {
                                console.log(`Retrying... (${attempt}/${maxRetries})`);
                                await new Promise(r => setTimeout(r, 1000)); // Wait 1 second before retry
                                continue;
                            }
                            
                            // If we're out of retries or it's not a retriable error
                            reject(error);
                            return;
                        }
                    }
                });
            }
            
            // Load languages
            loadLanguages().then(languages => {
                // Set up global language dropdown listener
                const globalLanguageSelect = document.getElementById('globalLanguageSelect');
                if (globalLanguageSelect) {
                    globalLanguageSelect.addEventListener('change', function() {
                        const selectedLanguage = this.value;
                        
                        // Update the language in the basic mode
                        const basicLanguageSelect = document.getElementById('basicLanguageSelect');
                        if (basicLanguageSelect) {
                            basicLanguageSelect.value = selectedLanguage;
                        }
                        
                        // Update the language in the bilingual mode for speaker 1
                        const languageSelect1 = document.getElementById('languageSelect1');
                        if (languageSelect1) {
                            languageSelect1.value = selectedLanguage;
                        }
                        
                        showStatus(`Input language changed to ${globalLanguageSelect.options[globalLanguageSelect.selectedIndex].text}`, 'info');
                    });
                }
            });
            
            // Run compatibility check
            checkBrowserCompatibility();
            
            // ========== BASIC MODE IMPLEMENTATION ==========
            
            // Basic mode file upload
            const basicUploadForm = document.getElementById('basicUploadForm');
            basicUploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const fileInput = document.getElementById('basicAudioFile');
                if (!fileInput.files.length) {
                    showStatus('Please select a file', 'warning');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('language', document.getElementById('basicLanguageSelect').value);
                formData.append('model', document.querySelector('input[name="uploadTranscriptionModel"]:checked').value);
                
                showStatus('Transcribing your audio...', 'info');
                
                try {
                    // Get transcription
                    const result = await sendToServer(formData);
                    
                    // Update transcript
                    document.getElementById('basicTranscript').innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>${result.text || "No transcript received."}</div>
                            <button id="basicPlayTranscriptButton" class="btn btn-sm btn-outline-primary btn-mobile-friendly">
                                <i class="fas fa-play"></i> <span>Play</span>
                            </button>
                        </div>
                    `;
                    
                    // Reattach event listener for play button
                    document.getElementById('basicPlayTranscriptButton').addEventListener('click', () => {
                        const text = result.text;
                        if (text) {
                            speakText(text, document.getElementById('basicLanguageSelect').value);
                        } else {
                            showStatus('No transcript to play', 'warning');
                        }
                    });
                    
                    showStatus('Transcription complete!', 'success');
                } catch (error) {
                    console.error('Upload error:', error);
                    
                    // User-friendly error messages
                    if (error.name === 'AbortError') {
                        showStatus('The request took too long to complete. Please try with a smaller file or check your connection.', 'warning');
                    } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                        showStatus('Network error. Please check your internet connection and try again.', 'danger');
                    } else {
                        showStatus(`Error: ${error.message}`, 'danger');
                    }
                }
            });
            
            // Basic mode copy buttons
            document.getElementById('basicCopyTranscriptButton').addEventListener('click', () => {
                const transcriptElement = document.getElementById('basicTranscript');
                const textElement = transcriptElement.querySelector('div:first-child');
                const text = textElement ? textElement.textContent : transcriptElement.textContent;
                
                if (text === 'Transcribed text will appear here...') {
                    showStatus('No text to copy', 'warning');
                    return;
                }
                
                copyTextToClipboard(text, 'Transcript copied to clipboard!');
            });
            
            // Basic mode play buttons
            document.getElementById('basicPlayTranscriptButton').addEventListener('click', () => {
                const transcriptElement = document.getElementById('basicTranscript');
                const textElement = transcriptElement.querySelector('div:first-child div');
                let text = '';
                
                if (textElement) {
                    text = textElement.textContent;
                } else {
                    const firstChild = transcriptElement.querySelector('div:first-child');
                    text = firstChild ? firstChild.textContent : transcriptElement.textContent;
                }
                
                if (text && text !== 'Transcribed text will appear here...') {
                    speakText(text, document.getElementById('basicLanguageSelect').value);
                } else {
                    showStatus('No transcript to play', 'warning');
                }
            });
            
            // Basic mode recording
            const basicRecordButton = document.getElementById('basicRecordButton');
            const basicRecordingStatus = document.getElementById('basicRecordingStatus');
            let basicRecording = null;
            let basicIsRecording = false;
            
            basicRecordButton.addEventListener('click', async () => {
                // If not recording, start recording
                if (!basicIsRecording) {
                    try {
                        basicRecordingStatus.textContent = 'Recording in progress...';
                        basicIsRecording = true;
                        
                        // Start recording using the enhanced function with button reference
                        basicRecording = await startRecording({
                            recordButton: basicRecordButton
                        });
                    } catch (error) {
                        // Error already handled by handleMicrophoneError
                        basicRecordButton.classList.remove('recording');
                        basicRecordingStatus.textContent = 'Click to start recording';
                        basicIsRecording = false;
                    }
                } else {
                    // Stop recording
                    if (basicRecording && basicRecording.mediaRecorder && 
                        basicRecording.mediaRecorder.state !== 'inactive') {
                        
                        basicRecordingStatus.textContent = 'Processing...';
                        
                        try {
                            // Stop the media recorder
                            basicRecording.mediaRecorder.stop();
                            
                            // Stop all tracks in the stream
                            basicRecording.stream.getTracks().forEach(track => track.stop());
                            
                            // Prepare form data
                            const formData = new FormData();
                            formData.append('language', document.getElementById('basicLanguageSelect').value);
                            formData.append('model', document.querySelector('input[name="transcriptionModel"]:checked').value);
                            
                            // Process the recorded audio after a short delay to ensure all data is collected
                            setTimeout(async () => {
                                try {
                                    // Process audio data
                                    const processedFormData = await processAudio(
                                        basicRecording.audioChunks,
                                        basicRecording.mediaRecorder.mimeType,
                                        formData
                                    );
                                    
                                    // Show transcribing status
                                    showStatus('Transcribing your recording...', 'info');
                                    
                                    // Send to server
                                    const result = await sendToServer(processedFormData);
                                    
                                    if (result.text) {
                                        // Update transcript
                                        document.getElementById('basicTranscript').innerHTML = `
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>${result.text}</div>
                                                <button id="basicPlayTranscriptButton" class="btn btn-sm btn-outline-primary btn-mobile-friendly">
                                                    <i class="fas fa-play"></i> <span>Play</span>
                                                </button>
                                            </div>
                                        `;
                                        
                                        // Reattach event listener for play button
                                        document.getElementById('basicPlayTranscriptButton').addEventListener('click', () => {
                                            speakText(result.text, document.getElementById('basicLanguageSelect').value);
                                        });
                                        
                                        showStatus('Transcription complete!', 'success');
                                    } else if (result.error) {
                                        console.error('Server error:', result.error);
                                        showStatus(`Error: ${result.error}`, 'danger', true);
                                    } else {
                                        showStatus('Transcription failed. Please try again.', 'danger');
                                    }
                                } catch (error) {
                                    console.error('Processing error:', error);
                                    
                                    if (error.message === 'No audio data recorded') {
                                        showStatus('No audio data recorded. Please try again and speak louder.', 'warning');
                                    } else if (error.name === 'AbortError') {
                                        showStatus('Request timed out. Please try a shorter recording or check your connection.', 'warning');
                                    } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                                        showStatus('Network error. Please check your internet connection.', 'danger');
                                    } else {
                                        showStatus(`Error: ${error.message}`, 'danger');
                                    }
                                }
                                
                                // Reset UI
                                basicRecordButton.classList.remove('recording');
                                basicRecordingStatus.textContent = 'Click to start recording';
                            }, 500); // Short delay to ensure all data is collected
                            
                        } catch (error) {
                            console.error('Error stopping recording:', error);
                            showStatus('Error processing recording. Please try again.', 'danger');
                            basicRecordButton.classList.remove('recording');
                            basicRecordingStatus.textContent = 'Click to start recording';
                        }
                    }
                    
                    basicIsRecording = false;
                }
            });
            
            // ========== BILINGUAL MODE IMPLEMENTATION ==========
            
            // Initialize speakers for the bilingual mode
            const speakers = [
                {
                    id: 1,
                    languageSelect: document.getElementById('languageSelect1'),
                    modelSelect: document.getElementById('modelSelect1'),
                    recordButton: document.getElementById('recordButton1'),
                    recordingStatus: document.getElementById('recordingStatus1'),
                    transcript: document.getElementById('transcript1'),
                    translation: document.getElementById('translation1'),
                    playButton: document.getElementById('playTranscript1Button'),
                    playTranslationButton: document.getElementById('playTranslation1Button'),
                    copyButton: document.getElementById('copyTranscript1Button'),
                    enableTTS: document.getElementById('enableTTS1'),
                    recording: null,
                    isRecording: false,
                    partnerId: 2  // The ID of the other speaker
                },
                {
                    id: 2,
                    languageSelect: document.getElementById('languageSelect2'),
                    modelSelect: document.getElementById('modelSelect2'),
                    recordButton: document.getElementById('recordButton2'),
                    recordingStatus: document.getElementById('recordingStatus2'),
                    transcript: document.getElementById('transcript2'),
                    translation: document.getElementById('translation2'),
                    playButton: document.getElementById('playTranscript2Button'),
                    playTranslationButton: document.getElementById('playTranslation2Button'),
                    copyButton: document.getElementById('copyTranscript2Button'),
                    enableTTS: document.getElementById('enableTTS2'),
                    recording: null,
                    isRecording: false,
                    partnerId: 1  // The ID of the other speaker
                }
            ];
            
            // Configure recording for both speakers
            speakers.forEach(speaker => {
                // Record button functionality
                speaker.recordButton.addEventListener('click', async () => {
                    // If not recording, start recording
                    if (!speaker.isRecording) {
                        try {
                            speaker.recordingStatus.textContent = 'Recording in progress...';
                            speaker.isRecording = true;
                            
                            // Start recording using the enhanced function with button reference
                            speaker.recording = await startRecording({
                                recordButton: speaker.recordButton
                            });
                        } catch (error) {
                            // Error already handled by handleMicrophoneError
                            speaker.recordButton.classList.remove('recording');
                            speaker.recordingStatus.textContent = 'Click to start recording';
                            speaker.isRecording = false;
                        }
                    } else {
                        // Stop recording
                        if (speaker.recording && speaker.recording.mediaRecorder && 
                            speaker.recording.mediaRecorder.state !== 'inactive') {
                            
                            speaker.recordingStatus.textContent = 'Processing...';
                            
                            try {
                                // Stop the media recorder
                                speaker.recording.mediaRecorder.stop();
                                
                                // Stop all tracks in the stream
                                speaker.recording.stream.getTracks().forEach(track => track.stop());
                                
                                // Get the partner's language for translation
                                const partnerId = speaker.partnerId;
                                const partnerLang = document.getElementById(`languageSelect${partnerId}`).value;
                                
                                // Prepare form data
                                const formData = new FormData();
                                formData.append('language', speaker.languageSelect.value);
                                formData.append('model', speaker.modelSelect.value);
                                
                                // Process the recorded audio after a short delay
                                setTimeout(async () => {
                                    try {
                                        // Process audio data
                                        const processedFormData = await processAudio(
                                            speaker.recording.audioChunks,
                                            speaker.recording.mediaRecorder.mimeType,
                                            formData
                                        );
                                        
                                        // Show transcribing status
                                        showStatus(`Transcribing Speaker ${speaker.id}'s recording...`, 'info');
                                        
                                        // Send to server
                                        const result = await sendToServer(processedFormData);
                                        
                                        if (result.text) {
                                            // Update transcript
                                            speaker.transcript.textContent = result.text;
                                            
                                            // Get the partner speaker
                                            const partnerSpeaker = speakers.find(s => s.id === partnerId);
                                            
                                            // Translate the transcript
                                            showStatus('Translating...', 'info');
                                            const translatedText = await translateText(result.text, partnerLang);
                                            
                                            if (translatedText) {
                                                // Update partner's translation display
                                                partnerSpeaker.translation.innerHTML = `
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>${translatedText}</div>
                                                        <div>
                                                            <button class="btn btn-sm btn-outline-primary btn-mobile-friendly" id="playTranslation${partnerId}Button">
                                                                <i class="fas fa-play"></i> <span>Play</span>
                                                            </button>
                                                            <button id="copyTranslationMobile${partnerId}Button" class="btn btn-sm btn-outline-secondary d-inline-block d-md-none">Copy</button>
                                                        </div>
                                                    </div>
                                                `;
                                                
                                                // Re-attach event listener for play translation button
                                                document.getElementById(`playTranslation${partnerId}Button`).addEventListener('click', () => {
                                                    speakText(translatedText, partnerLang);
                                                });
                                                
                                                // Play TTS if enabled for the partner
                                                if (partnerSpeaker.enableTTS.checked) {
                                                    speakText(translatedText, partnerLang);
                                                }
                                                
                                                showStatus('Transcription and translation complete!', 'success');
                                            } else {
                                                showStatus('Transcription complete, but translation failed.', 'warning');
                                            }
                                        } else if (result.error) {
                                            console.error('Server error:', result.error);
                                            showStatus(`Error: ${result.error}`, 'danger', true);
                                        } else {
                                            showStatus('Transcription failed. Please try again.', 'danger');
                                        }
                                    } catch (error) {
                                        console.error('Processing error:', error);
                                        
                                        if (error.message === 'No audio data recorded') {
                                            showStatus('No audio data recorded. Please try again and speak louder.', 'warning');
                                        } else if (error.name === 'AbortError') {
                                            showStatus('Request timed out. Please try a shorter recording or check your connection.', 'warning');
                                        } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                                            showStatus('Network error. Please check your internet connection.', 'danger');
                                        } else {
                                            showStatus(`Error: ${error.message}`, 'danger');
                                        }
                                    }
                                    
                                    // Reset UI
                                    speaker.recordButton.classList.remove('recording');
                                    speaker.recordingStatus.textContent = 'Click to start recording';
                                }, 500); // Short delay to ensure all data is collected
                                
                            } catch (error) {
                                console.error('Error stopping recording:', error);
                                showStatus('Error processing recording. Please try again.', 'danger');
                                speaker.recordButton.classList.remove('recording');
                                speaker.recordingStatus.textContent = 'Click to start recording';
                            }
                        }
                        
                        speaker.isRecording = false;
                    }
                });
                
                // Copy button functionality for original transcript
                speaker.copyButton.addEventListener('click', () => {
                    const text = speaker.transcript.textContent;
                    if (text === 'Your speech will appear here...') {
                        showStatus('No text to copy', 'warning');
                        return;
                    }
                    
                    copyTextToClipboard(text, `Speaker ${speaker.id}'s transcript copied!`);
                });
                
                // Copy buttons for translations (both desktop and mobile versions)
                const desktopCopyTranslationBtn = document.getElementById(`copyTranslation${speaker.id}Button`);
                const mobileCopyTranslationBtn = document.getElementById(`copyTranslationMobile${speaker.id}Button`);
                
                // Function to handle copying translation for this speaker
                const copyTranslationHandler = () => {
                    // Get the text content properly from the container div
                    const translationElement = speaker.translation;
                    const textElement = translationElement.querySelector('div:first-child div');
                    let translationText = textElement ? textElement.textContent : "";
                    
                    if (!translationText || translationText === "Translation will appear here...") {
                        showStatus('No translation to copy', 'warning');
                        return;
                    }
                    
                    copyTextToClipboard(translationText, `Speaker ${speaker.id}'s translation copied!`);
                };
                
                // Add event listeners to both desktop and mobile copy buttons
                desktopCopyTranslationBtn.addEventListener('click', copyTranslationHandler);
                mobileCopyTranslationBtn.addEventListener('click', copyTranslationHandler);
                
                // Play original transcript button functionality
                speaker.playButton.addEventListener('click', () => {
                    const text = speaker.transcript.textContent;
                    if (text && text !== 'Your speech will appear here...') {
                        speakText(text, speaker.languageSelect.value);
                    } else {
                        showStatus('No transcript to play', 'warning');
                    }
                });
                
                // Play translation button functionality
                speaker.playTranslationButton.addEventListener('click', () => {
                    // Get the text content properly from the container div
                    const translationElement = speaker.translation;
                    const textElement = translationElement.querySelector('div:first-child div');
                    let translationText = textElement ? textElement.textContent : "";
                    
                    if (!translationText || translationText === "Translation will appear here...") {
                        showStatus('No translation to play', 'warning');
                        return;
                    }
                    
                    // Get partner's language for the translation
                    const partnerId = speaker.partnerId;
                    const partnerLang = document.getElementById(`languageSelect${partnerId}`).value;
                    speakText(translationText, partnerLang);
                });
            });
        });

        // Helper function for copying text to clipboard
        function copyTextToClipboard(text, successMessage) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => showStatus(successMessage, 'success'))
                    .catch(err => showStatus('Failed to copy: ' + err, 'danger'));
            } else {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showStatus(successMessage, 'success');
                    } else {
                        showStatus('Copy failed. Please try selecting and copying manually.', 'warning');
                    }
                } catch (err) {
                    showStatus('Copy failed. Please try selecting and copying manually.', 'warning');
                }
                
                document.body.removeChild(textarea);
            }
        }
    </script>
</body>
</html>