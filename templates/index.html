<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vocal Local - Speech to Text</title>

  <!-- Favicon -->
  <link rel="icon" href="{{ versioned_url_for('static', filename='favicon.ico') }}" type="image/x-icon">

  <!-- Cache Control Meta Tags -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Styles -->
  <link rel="stylesheet" href="{{ versioned_url_for('static', filename='styles.css') }}">
  <link rel="stylesheet" href="{{ versioned_url_for('static', filename='auth.css') }}">
  <link rel="stylesheet" href="{{ versioned_url_for('static', filename='css/upgrade-modal.css') }}">
  <link rel="stylesheet" href="{{ versioned_url_for('static', filename='css/email-verification-modal.css') }}">
  <link rel="stylesheet" href="{{ versioned_url_for('static', filename='css/brand-link.css') }}">
  <link rel="stylesheet" href="{{ versioned_url_for('static', filename='mobile-nav.css') }}">
  <link rel="stylesheet" href="{{ versioned_url_for('static', filename='css/mobile-performance.css') }}" media="screen and (max-width: 768px)">
  <link rel="stylesheet" href="{{ versioned_url_for('static', filename='css/mobile-basic-mode.css') }}">
  <!-- Critical fix for mobile icon visibility - load without media query for immediate effect -->
  <link rel="stylesheet" href="{{ versioned_url_for('static', filename='css/mobile-icon-theme-fix.css') }}">

  <!-- Payment Success Animation Styles -->
  <style>
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    /* THEME-AWARE ICON FIX: Ensure FontAwesome icons are visible with proper contrast */
    #basic-mode .card-header i.fas,
    #basic-mode .card-header i.far,
    #basic-mode .card-header i.fab,
    #basic-mode .card-header i[class*="fa-"] {
      font-family: "Font Awesome 6 Free", "Font Awesome 5 Free", "FontAwesome" !important;
      font-weight: 900 !important;
      font-style: normal !important;
      display: inline-block !important;
      opacity: 1 !important;
      visibility: visible !important;
      font-size: 14px !important;
      line-height: 1 !important;
    }

    /* LIGHT THEME: Purple icons for brand consistency */
    [data-theme="light"] #basic-mode .card-header i.fas,
    [data-theme="light"] #basic-mode .card-header i[class*="fa-"] {
      color: hsl(var(--primary)) !important; /* Purple color for light theme */
    }

    [data-theme="light"] #basic-mode .card-header .button,
    [data-theme="light"] #basic-mode .card-header .header-record-button {
      background: hsla(var(--primary), 0.1) !important;
      border: 1px solid hsla(var(--primary), 0.2) !important;
      color: hsl(var(--primary)) !important;
    }

    [data-theme="light"] #basic-record-btn {
      background: hsl(var(--primary)) !important; /* Purple brand background for light theme */
      color: white !important; /* Keep white text on purple background */
    }

    [data-theme="light"] #basic-record-btn i.fa-microphone {
      color: white !important; /* White icon on primary background */
      font-family: "Font Awesome 6 Free", "Font Awesome 5 Free", FontAwesome !important;
      font-weight: 900 !important;
      font-style: normal !important;
      display: inline-block !important;
      opacity: 1 !important;
      visibility: visible !important;
    }

    [data-theme="light"] #basic-upload-btn i.fa-paperclip,
    [data-theme="light"] #basic-play-btn i.fa-play,
    [data-theme="light"] #basic-stop-btn i.fa-stop,
    [data-theme="light"] #basic-copy-btn i.fa-copy {
      color: black !important; /* Black icons for better visibility in light theme */
    }

    /* HIGHEST PRIORITY FIX: Override any inline styles that make buttons invisible */
    [data-theme="light"] #basic-upload-btn[style],
    [data-theme="light"] #basic-play-btn[style],
    [data-theme="light"] #basic-stop-btn[style],
    [data-theme="light"] #basic-copy-btn[style] {
      background: rgba(255, 255, 255, 0.9) !important;
      border: 1px solid rgba(255, 255, 255, 0.7) !important;
      color: hsl(var(--primary)) !important;
      opacity: 1 !important;
      visibility: visible !important;
    }

    [data-theme="light"] #basic-upload-btn[style] i,
    [data-theme="light"] #basic-play-btn[style] i,
    [data-theme="light"] #basic-stop-btn[style] i,
    [data-theme="light"] #basic-copy-btn[style] i {
      color: black !important;
      opacity: 1 !important;
      visibility: visible !important;
    }

    /* SIMPLIFIED: Ensure microphone icon is always visible on record button */
    #basic-record-btn i {
      font-family: "Font Awesome 6 Free" !important;
      font-weight: 900 !important;
      display: inline-block !important;
      opacity: 1 !important;
      visibility: visible !important;
      color: white !important;
      font-size: 16px !important;
    }



    /* Ensure record button background is always purple brand colored */
    #basic-record-btn.header-record-button {
      background: hsl(var(--primary)) !important; /* Purple brand background */
      border: 2px solid hsl(var(--primary)) !important; /* Purple brand border */
      color: white !important;
    }

    /* CRITICAL: Force black icons in light theme for non-record buttons */
    [data-theme="light"] #basic-mode .card-header #basic-upload-btn i.fas,
    [data-theme="light"] #basic-mode .card-header #basic-play-btn i.fas,
    [data-theme="light"] #basic-mode .card-header #basic-stop-btn i.fas,
    [data-theme="light"] #basic-mode .card-header #basic-copy-btn i.fas,
    [data-theme="light"] #basic-upload-btn i.fa-paperclip,
    [data-theme="light"] #basic-play-btn i.fa-play,
    [data-theme="light"] #basic-stop-btn i.fa-stop,
    [data-theme="light"] #basic-copy-btn i.fa-copy {
      color: black !important;
      font-weight: 900 !important;
      opacity: 1 !important;
      visibility: visible !important;
    }

    /* SIMPLIFIED: White microphone icon on blue record button */
    [data-theme="light"] #basic-record-btn i,
    [data-theme="dark"] #basic-record-btn i {
      color: white !important;
      font-family: "Font Awesome 6 Free" !important;
      font-weight: 900 !important;
      display: inline-block !important;
      opacity: 1 !important;
      visibility: visible !important;
      font-size: 16px !important;
    }

    /* Dark theme specific purple styling for record button */
    [data-theme="dark"] #basic-record-btn.header-record-button {
      background: hsl(var(--primary)) !important; /* Purple brand for dark theme */
      border: 2px solid hsl(var(--primary)) !important;
    }

    /* Dark theme: White microphone icon for contrast */
    [data-theme="dark"] #basic-record-btn i.fas.fa-microphone,
    [data-theme="dark"] #basic-record-btn i {
      color: white !important;
      background-color: transparent !important;
      padding: 0 !important;
      border-radius: 0 !important;
      font-family: "Font Awesome 6 Free", "Font Awesome 5 Free", FontAwesome !important;
      font-weight: 900 !important;
      display: inline-block !important;
      opacity: 1 !important;
      visibility: visible !important;
    }

    /* SIMPLIFIED: Microphone icon override class */
    .microphone-icon-override {
      color: white !important;
      font-family: "Font Awesome 6 Free" !important;
      font-weight: 900 !important;
      display: inline-block !important;
      opacity: 1 !important;
      visibility: visible !important;
      font-size: 16px !important;
    }

    /* DARK THEME: Light icons for contrast against dark backgrounds */
    [data-theme="dark"] #basic-mode .card-header i.fas,
    [data-theme="dark"] #basic-mode .card-header i[class*="fa-"] {
      color: white !important; /* Light color for dark theme */
    }

    [data-theme="dark"] #basic-mode .card-header .button,
    [data-theme="dark"] #basic-mode .card-header .header-record-button {
      background: rgba(255, 255, 255, 0.15) !important;
      border: 1px solid rgba(255, 255, 255, 0.25) !important;
      color: white !important;
    }

    [data-theme="dark"] #basic-record-btn {
      background: hsl(var(--primary)) !important; /* Purple brand for dark theme */
      color: white !important;
    }

    [data-theme="dark"] #basic-record-btn i.fa-microphone,
    [data-theme="dark"] #basic-upload-btn i.fa-paperclip,
    [data-theme="dark"] #basic-play-btn i.fa-play,
    [data-theme="dark"] #basic-stop-btn i.fa-stop,
    [data-theme="dark"] #basic-copy-btn i.fa-copy {
      color: white !important; /* White icons for dark theme */
      font-family: "Font Awesome 6 Free", "Font Awesome 5 Free", FontAwesome !important;
      font-weight: 900 !important;
      font-style: normal !important;
      display: inline-block !important;
      opacity: 1 !important;
      visibility: visible !important;
    }

    /* SYSTEM THEME: Fallback to CSS variables */
    [data-theme="system"] #basic-mode .card-header i.fas,
    [data-theme="system"] #basic-mode .card-header i[class*="fa-"] {
      color: hsl(var(--foreground)) !important;
    }

    /* CRITICAL FIX: Ensure buttons are always visible in mobile view */
    @media (max-width: 768px) {
      #basic-mode .card-header .flex {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
      }

      #basic-mode .card-header .button,
      #basic-mode .card-header .header-record-button,
      #basic-record-btn,
      #basic-upload-btn,
      #basic-play-btn,
      #basic-stop-btn,
      #basic-copy-btn {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        min-width: 36px !important;
        min-height: 36px !important;
      }

      /* Force FontAwesome icons to be visible */
      #basic-mode .card-header i.fas,
      #basic-mode .card-header i.far,
      #basic-mode .card-header i.fab,
      #basic-mode .card-header i[class*="fa-"] {
        display: inline-block !important;
        visibility: visible !important;
        opacity: 1 !important;
        font-size: 14px !important;
      }

      /* Light theme mobile icons - make non-record icons black for visibility */
      [data-theme="light"] #basic-mode .card-header i.fas,
      [data-theme="light"] #basic-mode .card-header i[class*="fa-"] {
        color: black !important;
      }

      /* Override for specific non-record button icons */
      [data-theme="light"] #basic-upload-btn i,
      [data-theme="light"] #basic-play-btn i,
      [data-theme="light"] #basic-stop-btn i,
      [data-theme="light"] #basic-copy-btn i {
        color: black !important;
        font-weight: 900 !important;
        opacity: 1 !important;
        visibility: visible !important;
      }

      /* Keep microphone icon white on record button */
      [data-theme="light"] #basic-record-btn i.fa-microphone,
      [data-theme="light"] #basic-record-btn i {
        color: white !important;
        font-family: "Font Awesome 6 Free", "Font Awesome 5 Free", FontAwesome !important;
        font-weight: 900 !important;
        display: inline-block !important;
        opacity: 1 !important;
        visibility: visible !important;
      }

      /* Dark theme mobile icons */
      [data-theme="dark"] #basic-mode .card-header i.fas,
      [data-theme="dark"] #basic-mode .card-header i[class*="fa-"] {
        color: white !important;
      }

      /* Debug borders - uncomment to see button boundaries */
      /*
      #basic-mode .card-header .button {
        border: 2px solid red !important;
      }
      #basic-mode .card-header i {
        background: yellow !important;
      }
      */
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="flex flex-col md:flex-row items-start md:items-center justify-between gap-1 mb-2 mt-1">
      <!-- Left Section: Title Only -->
      <div class="header-title-container">
        <h1 class="text-2xl font-bold" style="color: hsl(var(--primary)); font-family: 'Poppins', sans-serif;">
          <a href="{{ url_for('main.index') }}" style="text-decoration: none; color: inherit;">Vocal Local</a>
        </h1>
        <p id="app-subtitle" class="text-sm text-muted">Accurate Multilingual Speech-to-Text Transcription</p>
      </div>

      <!-- Center Section: Bilingual Mode Toggle -->
      <div class="header-center flex items-center gap-1">
        <span class="text-sm font-medium bilingual-mode-label">Bilingual Mode</span>
        <label class="toggle-switch" title="Toggle bilingual mode">
          <input type="checkbox" id="bilingual-mode">
          <span class="slider round"></span>
        </label>
      </div>
      <!-- End Bilingual Mode Toggle -->

      <!-- Right Section: Settings + Theme + History + Profile -->
      <div class="flex items-center gap-2 mt-0">
        <!-- Settings Button -->
        <button id="settings-toggle" class="button button-outline button-icon" title="Settings">
          <i class="fas fa-cog"></i>
        </button>
        <!-- End Settings Button -->

        <!-- Theme Selector -->
        <div class="theme-selector">
          <button id="theme-toggle-btn" class="button button-outline button-icon" title="Toggle theme">
            <i class="fas fa-moon"></i>
          </button>
        </div>
        <!-- End Theme Selector -->

        <!-- Upgrade Button -->
        <button id="upgrade-button" class="button button-outline button-icon upgrade-header-btn" title="Upgrade Plan">
          <i class="fas fa-crown"></i>
          <span class="upgrade-text">Upgrade</span>
        </button>
        <!-- End Upgrade Button -->

        <!-- Authentication Links / Profile Section -->
        {% if current_user.is_authenticated %}
          <div class="user-avatar-menu">
            <button id="avatar-button" class="avatar-button" aria-expanded="false">
              <div class="avatar-circle">{{ current_user.username[0]|upper }}</div>
              <i class="fas fa-chevron-down dropdown-arrow"></i>
            </button>
            <div id="user-dropdown" class="user-dropdown">
              <a href="{{ url_for('main.dashboard') }}" class="dropdown-item">
                <i class="fas fa-tachometer-alt"></i> Dashboard
              </a>
              <a href="{{ url_for('auth.profile') }}" class="dropdown-item">
                <i class="fas fa-user"></i> Profile
              </a>
              <a href="{{ url_for('main.history', type='all') }}" class="dropdown-item">
                <i class="fas fa-history"></i> History
              </a>
              {% if current_user.is_admin %}
              <div class="dropdown-divider"></div>
              <a href="{{ url_for('admin.dashboard') }}" class="dropdown-item">
                <i class="fas fa-chart-line"></i> Admin Dashboard
              </a>
              <a href="{{ url_for('admin.users') }}" class="dropdown-item">
                <i class="fas fa-users"></i> User Management
              </a>
              {% endif %}
              <div class="dropdown-divider"></div>
              <a href="{{ url_for('auth.logout') }}" class="dropdown-item">
                <i class="fas fa-sign-out-alt"></i> Logout
              </a>
            </div>
          </div>
        {% else %}
          <a href="{{ url_for('auth.login') }}" class="button button-outline">Login</a>
          <a href="{{ url_for('auth.register') }}" class="button button-primary">Register</a>
        {% endif %}
      </div>
    </header>

    <!-- Settings Panel -->
    <div id="settings-panel" class="settings-panel mb-4" style="display: none;">
      <div class="settings-content">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Language Selection -->
          <div class="form-group">
            <label for="global-language" class="form-label">Interface Language:</label>
            <select id="global-language" class="form-select">
              <!-- Will be populated with languages -->
            </select>
          </div>

          <!-- Transcription Model Selector -->
          <div class="form-group">
            <label for="global-transcription-model" class="form-label">Transcription Model:</label>
            <select id="global-transcription-model" class="form-select mt-2">
              <option value="gemini-2.0-flash-lite" selected>Gemini 2.0 Flash Lite</option>
              <option value="gpt-4o-mini-transcribe">OpenAI GPT-4o Mini</option>
              <option value="gpt-4o-transcribe">OpenAI GPT-4o</option>
              <option value="gemini-2.5-flash-preview-04-17">Gemini 2.5 Flash Preview</option>
            </select>
          </div>

          <!-- Translation Model Selector (only visible in bilingual mode) -->
          <div id="translation-model-container" class="form-group" style="display: none;">
            <label for="translation-model-select" class="form-label">Translation Model:</label>
            <select id="translation-model-select" class="form-select mt-2">
              <option value="gemini-2.0-flash-lite" selected>Gemini 2.0 Flash Lite</option>
              <option value="gemini-2.5-flash">Gemini 2.5 Flash Preview</option>
            </select>
          </div>
          <!-- End Translation Model Selector -->

          <!-- TTS Model Selector -->
          <div class="form-group">
            <label for="tts-model-select" class="form-label">Text-to-Speech Model:</label>
            <select id="tts-model-select" class="form-select mt-2">
              <option value="gemini-2.5-flash-tts" selected>üîí Gemini 2.5 Flash TTS</option>
              <option value="gpt4o-mini">üîí GPT-4o Mini TTS</option>
              <option value="openai">üîí OpenAI TTS-1</option>
            </select>
          </div>
          <!-- End TTS Model Selector -->

          <!-- Interpretation Model Selector -->
          <div class="form-group interpretation-setting">
            <label for="interpretation-model-select" class="form-label">AI Interpretation Model:</label>
            <select id="interpretation-model-select" class="form-select mt-2">
              <option value="gemini-2.0-flash-lite" selected>Gemini 2.0 Flash Lite</option>
              <option value="gemini-2.5-flash">Gemini 2.5 Flash Preview</option>
            </select>
          </div>
          <!-- End Interpretation Model Selector -->

          <!-- Interpretation Tone Selector -->
          <div class="form-group interpretation-setting">
            <label for="interpretation-tone-select" class="form-label">AI Interpretation Tone:</label>
            <select id="interpretation-tone-select" class="form-select mt-2">
              <option value="professional" selected>Professional</option>
              <option value="simplified">Simplified</option>
              <option value="academic">Academic</option>
              <option value="ai-prompts">AI Prompts</option>
            </select>
          </div>
          <!-- End Interpretation Tone Selector -->

          <!-- Interpretation Toggle -->
          <div class="form-group">
            <div class="flex items-center justify-between">
              <label for="enable-interpretation" class="form-label">Enable AI Interpretation:</label>
              <label class="toggle-switch" title="Toggle AI interpretation">
                <input type="checkbox" id="enable-interpretation" checked>
                <span class="slider round"></span>
              </label>
            </div>
          </div>
          <!-- End Interpretation Toggle -->
        </div>
      </div>
    </div>
    <!-- End Settings Panel -->

    <!-- Status Message -->
    <div id="status" class="status status-info" style="display: none;">
      Status message will appear here
    </div>

    <!-- BASIC MODE -->
    <div id="basic-mode" class="space-y-6">
      <!-- Voice Transcription Card -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Voice Transcription</h2>
        </div>

        <!-- Centered Recording Button Section -->
        <div class="record-button-section">
          <button id="basic-record-btn" class="centered-record-button" title="Start voice recording">
            <i class="fas fa-microphone"></i>
            <span class="record-button-text">Start Recording</span>
          </button>
        </div>

        <div class="card-content">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="space-y-4">
              <div class="form-group">
                <label for="basic-language" class="form-label">Input Language:</label>
                <select id="basic-language" class="form-select"></select>
              </div>
            </div>

            <div class="col-span-3">
              <div class="flex items-center justify-between mb-2">
                <label for="basic-transcript" class="form-label">Transcript</label>
                <div class="flex items-center gap-2">
                  <button id="basic-upload-btn" class="button button-outline button-icon" title="Upload audio file" onclick="document.getElementById('basic-file-input').click()">
                    <i class="fas fa-paperclip"></i>
                  </button>
                  <button id="basic-play-btn" class="button button-outline button-icon" title="Play transcription">
                    <i class="fas fa-play"></i>
                  </button>
                  <button id="basic-stop-btn" class="button button-outline button-icon" title="Stop playback" style="display: none;">
                    <i class="fas fa-stop"></i>
                  </button>
                  <button id="basic-copy-btn" class="button button-outline button-icon" title="Copy transcript">
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
              </div>
              <textarea id="basic-transcript" class="form-textarea w-full" placeholder="Your transcription will appear here..."></textarea>
              <div class="transcript-controls mt-2 flex justify-between">
                <div>
                  <button id="basic-undo-btn" class="button button-outline button-small">Undo Edits</button>
                </div>
              </div>

              <!-- AI Interpretation Section -->
              <div class="interpretation-section mt-4">
                <div class="interpretation-title">
                  <label class="form-label">AI Interpretation:</label>
                  <div class="flex items-center gap-2">
                    <button id="basic-interpret-btn" class="button button-small">Interpret Text</button>
                    <button id="basic-play-interpretation-btn" class="button button-outline button-icon" title="Play interpretation">
                      <i class="fas fa-play"></i>
                    </button>
                    <button id="basic-stop-interpretation-btn" class="button button-outline button-icon" title="Stop playback" style="display: none;">
                      <i class="fas fa-stop"></i>
                    </button>
                    <button id="basic-copy-interpretation-btn" class="button button-outline button-icon" title="Copy interpretation">
                      <i class="fas fa-copy"></i>
                    </button>
                  </div>
                </div>
                <textarea id="basic-interpretation" class="form-textarea w-full" placeholder="AI interpretation will appear here..." readonly></textarea>
              </div>
              <!-- End AI Interpretation Section -->
            </div>
          </div>
        </div>
      </div>

      <!-- Hidden file input for upload -->
      <input type="file" id="basic-file-input" accept="audio/*" class="visually-hidden">
    </div>

    <!-- BILINGUAL MODE -->
    <div id="bilingual-mode-content" class="space-y-1" style="display: none;">

      <!-- Quick Conversation Interface -->
      <div class="card bilingual-conversation-card">
        <div class="card-header">
          <h2 class="card-title">Quick Conversation</h2>
          <div class="flex items-center gap-2">
            <span id="bilingual-recording-timer" class="timer-display">00:00</span>
          </div>
        </div>
        <div class="card-content">
          <!-- Language Selection Row -->
          <div class="language-selection-row">
            <div class="language-group">
              <label for="bilingual-from-language" class="form-label">From:</label>
              <select id="bilingual-from-language" class="form-select language-select"></select>
            </div>
            <div class="language-arrow">
              <i class="fas fa-arrow-right"></i>
            </div>
            <div class="language-group">
              <label for="bilingual-to-language" class="form-label">To:</label>
              <select id="bilingual-to-language" class="form-select language-select"></select>
            </div>
          </div>

          <!-- Hold to Record Button -->
          <div class="record-button-container">
            <button id="bilingual-hold-record-btn" class="hold-record-button">
              <i class="fas fa-microphone"></i>
              <span>Hold to Record</span>
            </button>
          </div>

          <!-- Action Buttons Row -->
          <div class="action-buttons-row">
            <button id="bilingual-manual-record" class="action-button manual-record-btn">
              <i class="fas fa-microphone"></i>
              <span>Manual Record</span>
            </button>
            <button id="bilingual-translate-btn" class="action-button translate-btn">
              <i class="fas fa-language"></i>
              <span>Translate</span>
            </button>
            <button id="bilingual-upload-btn" class="action-button upload-btn" onclick="document.getElementById('bilingual-file-input').click()">
              <i class="fas fa-upload"></i>
              <span>Upload</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Conversation Results -->
      <div class="card conversation-results-card">
        <div class="card-header">
          <h2 class="card-title">Conversation Results</h2>
          <div class="flex items-center gap-2">
            <button id="bilingual-clear-results" class="button button-outline button-small" title="Clear results">
              <i class="fas fa-trash"></i>
              <span>Clear</span>
            </button>
          </div>
        </div>
        <div class="card-content">
          <div class="conversation-results-grid">
            <!-- Original Text Column -->
            <div class="result-column original-column">
              <div class="result-header">
                <div class="result-title">
                  <i class="fas fa-microphone"></i>
                  <span>Original ( <span id="original-language-display">English (English)</span> )</span>
                </div>
                <div class="result-controls">
                  <button id="play-original" class="button button-outline button-icon" title="Play original">
                    <i class="fas fa-play"></i>
                  </button>
                  <button id="stop-original" class="button button-outline button-icon" title="Stop playback" style="display: none;">
                    <i class="fas fa-stop"></i>
                  </button>
                  <button id="copy-original" class="button button-outline button-icon" title="Copy original">
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
              </div>
              <div class="result-content">
                <textarea id="bilingual-original-text" class="form-textarea result-textarea" placeholder="Your speech will appear here..."></textarea>
              </div>
            </div>

            <!-- Translation Text Column -->
            <div class="result-column translation-column">
              <div class="result-header">
                <div class="result-title">
                  <i class="fas fa-language"></i>
                  <span>Translation ( <span id="translation-language-display">Spanish (Espa√±ol)</span> )</span>
                </div>
                <div class="result-controls">
                  <button id="play-translation" class="button button-outline button-icon" title="Play translation">
                    <i class="fas fa-play"></i>
                  </button>
                  <button id="stop-translation" class="button button-outline button-icon" title="Stop playback" style="display: none;">
                    <i class="fas fa-stop"></i>
                  </button>
                  <button id="copy-translation" class="button button-outline button-icon" title="Copy translation">
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
              </div>
              <div class="result-content">
                <textarea id="bilingual-translation-text" class="form-textarea result-textarea" placeholder="Translation will appear here..." readonly></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Hidden file input for bilingual mode -->
      <input type="file" id="bilingual-file-input" accept="audio/*" class="visually-hidden">
    </div>

    <!-- About section moved to dedicated /about page for better UX -->
  </div>

  <!-- Scripts -->
  <!-- ProgressBar.js for circular progress indicator -->
  <script src="https://cdn.jsdelivr.net/npm/progressbar.js@1.1.0/dist/progressbar.min.js"></script>

  <!-- Cache Manager -->
  <script src="{{ versioned_url_for('static', filename='cache-manager.js') }}"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <!-- Usage Validation -->
  <script src="{{ versioned_url_for('static', filename='js/usage-validation.js') }}"></script>

  <!-- Plan Access Control -->
  <script src="{{ versioned_url_for('static', filename='js/plan-access-control.js') }}"></script>

  <script src="{{ versioned_url_for('static', filename='script.js') }}"></script>
  <script src="{{ versioned_url_for('static', filename='auth.js') }}"></script>
  <script src="{{ versioned_url_for('static', filename='upload-progress.js') }}"></script>

  <!-- Enhanced file size warnings -->
  <script src="{{ versioned_url_for('static', filename='file-size-warning.js') }}"></script>

  <!-- Bilingual Conversation Mode -->
  <script src="{{ versioned_url_for('static', filename='js/bilingual-conversation.js') }}"></script>

  <!-- Synchronized TTS System - TEMPORARILY DISABLED to fix multiple voices issue -->
  <!-- <script src="{{ versioned_url_for('static', filename='sync-tts.js') }}" defer></script> -->

  <!-- TTS Fix Notification -->
  <script>
    // Add a global error handler for TTS-related issues
    window.addEventListener('error', function(event) {
      if (event.message && (event.message.includes('TTS') || event.message.includes('audio'))) {
        console.log('Caught TTS-related error:', event.message);
        event.preventDefault();
      }
    });
  </script>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
      <script>
        // Auto-hide flash messages after 5 seconds
        setTimeout(function() {
          const flashMessages = document.querySelector('.flash-messages');
          if (flashMessages) {
            flashMessages.style.display = 'none';
          }
        }, 5000);
      </script>
    {% endif %}
  {% endwith %}
  <!-- Set user role for model access control -->
  {% if current_user.is_authenticated %}
  <!-- User data injection for authenticated users -->
  <script type="application/json" id="user-data">
    {{ {
      'email': current_user.email,
      'username': current_user.username,
      'role': current_user.role|default('normal_user'),
      'is_admin': current_user.is_admin
    }|tojson }}
  </script>
  <script type="application/json" id="user-role">{{ (current_user.role|default('normal_user'))|tojson }}</script>
  {% endif %}

  <script>
    // Set current user information for model access control
    (function() {
      var userDataElement = document.getElementById('user-data');
      var userRoleElement = document.getElementById('user-role');

      if (userDataElement && userRoleElement) {
        // Authenticated user
        try {
          window.currentUser = JSON.parse(userDataElement.textContent);
          window.currentUserRole = JSON.parse(userRoleElement.textContent);
        } catch (e) {
          console.error('Failed to parse user data:', e);
          window.currentUser = null;
          window.currentUserRole = 'normal_user';
        }
      } else {
        // Non-authenticated user
        window.currentUser = null;
        window.currentUserRole = 'normal_user';
      }
    })();
  </script>

  <!-- TTS Access Control -->
  <script src="{{ versioned_url_for('static', filename='js/tts-access-control.js') }}"></script>

  <script src="{{ versioned_url_for('static', filename='background-processing.js') }}"></script>
  <script src="{{ versioned_url_for('static', filename='common.js') }}"></script>
  {% if current_user.is_authenticated %}
  <script src="{{ versioned_url_for('static', filename='js/usage-enforcement.js') }}"></script>
  {% endif %}

  <!-- Upgrade Button Logic -->
  <script>
    // Set authentication status and URLs for JavaScript
    window.upgradeConfig = {
    isAuthenticated: {{ 'true' if current_user.is_authenticated() else 'false' }},
    pricingUrl: "{{ url_for('pricing') }}",
    loginUrl: "{{ url_for('auth.login', next='/pricing') }}",
    showUpgradePrompts: {{ 'true' if show_upgrade_prompts else 'false' }},
    planType: "{{ plan_type or 'free' }}"
  };

    // Payment flow state management
    window.paymentFlowManager = {
      isProcessing: false,
      upgradeButton: null,

      init: function() {
        this.upgradeButton = document.getElementById('upgrade-button');
        this.setupEventListeners();
        this.checkForReturnFromPayment();
      },

      setupEventListeners: function() {
        if (!this.upgradeButton) {
          console.warn('Upgrade button not found on page');
          return;
        }

        console.log('Setting up upgrade button event listener');

        // Handle upgrade button click
        this.upgradeButton.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('Upgrade button clicked');
          this.handleUpgradeClick();
        });

        // Handle page visibility changes (detect return from external sites)
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            this.handlePageVisible();
          }
        });

        // Handle beforeunload to set processing state
        window.addEventListener('beforeunload', () => {
          if (this.isProcessing) {
            sessionStorage.setItem('upgradeProcessing', 'true');
          }
        });
      },

      handleUpgradeClick: function() {
        console.log('handleUpgradeClick called');

        if (this.isProcessing) {
          console.log('Upgrade already in progress');
          return;
        }

        // Check if upgrade config is available
        if (!window.upgradeConfig) {
          console.error('Upgrade configuration not found');
          alert('Upgrade configuration error. Please refresh the page and try again.');
          return;
        }

        this.setProcessingState(true);

        try {
          // Check if user is authenticated
          if (window.upgradeConfig.isAuthenticated) {
            console.log('Authenticated user clicking upgrade - redirecting to pricing');
            console.log('Pricing URL:', window.upgradeConfig.pricingUrl);
            window.location.href = window.upgradeConfig.pricingUrl;
          } else {
            console.log('Unauthenticated user clicking upgrade - redirecting to login');
            console.log('Login URL:', window.upgradeConfig.loginUrl);
            window.location.href = window.upgradeConfig.loginUrl;
          }
        } catch (error) {
          console.error('Error in handleUpgradeClick:', error);
          this.setProcessingState(false);
          alert('An error occurred. Please try again.');
        }
      },

      handlePageVisible: function() {
        // Clear processing state when user returns to page
        if (this.isProcessing || sessionStorage.getItem('upgradeProcessing')) {
          console.log('User returned to page, clearing processing state');
          this.setProcessingState(false);
          sessionStorage.removeItem('upgradeProcessing');
        }
      },

      checkForReturnFromPayment: function() {
        // Check if user is returning from a payment flow
        const wasProcessing = sessionStorage.getItem('upgradeProcessing');
        if (wasProcessing) {
          console.log('Detected return from payment flow, clearing state');
          this.setProcessingState(false);
          sessionStorage.removeItem('upgradeProcessing');
        }

        // Check URL parameters for payment status
        const urlParams = new URLSearchParams(window.location.search);
        const paymentStatus = urlParams.get('payment');

        if (paymentStatus === 'cancelled') {
          this.showPaymentCancelledMessage();
          // Clean up URL
          const cleanUrl = window.location.pathname;
          window.history.replaceState({}, document.title, cleanUrl);
        }
      },

      setProcessingState: function(processing) {
        this.isProcessing = processing;

        if (!this.upgradeButton) return;

        if (processing) {
          this.upgradeButton.classList.add('loading');
          this.upgradeButton.disabled = true;
          this.upgradeButton.title = 'Processing upgrade...';
        } else {
          this.upgradeButton.classList.remove('loading');
          this.upgradeButton.disabled = false;
          this.upgradeButton.title = 'Upgrade Plan';
        }
      },

      showPaymentCancelledMessage: function() {
        // Show a brief notification that payment was cancelled
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #f8d7da;
          color: #721c24;
          padding: 12px 20px;
          border-radius: 8px;
          border: 1px solid #f5c6cb;
          z-index: 1000;
          font-size: 14px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        `;
        notification.textContent = 'Payment cancelled. You can try again anytime.';

        document.body.appendChild(notification);

        // Auto-remove after 5 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 5000);
      }
    };

    // Check for payment success on page load
    window.paymentFlowManager.checkPaymentSuccess = function() {
      const urlParams = new URLSearchParams(window.location.search);
      const paymentStatus = urlParams.get('payment');
      const planType = urlParams.get('plan');

      if (paymentStatus === 'success' && planType) {
        // Show success notification
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
          color: white;
          padding: 20px 25px;
          border-radius: 10px;
          font-weight: 500;
          z-index: 10000;
          max-width: 400px;
          box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
          animation: slideInRight 0.5s ease-out;
        `;

        const planName = planType === 'basic' ? 'Basic Plan' : 'Professional Plan';
        notification.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-check-circle" style="font-size: 24px;"></i>
            <div>
              <div style="font-weight: 600; margin-bottom: 5px;">Payment Successful! üéâ</div>
              <div style="font-size: 14px; opacity: 0.9;">Welcome to VocalLocal ${planName}!</div>
            </div>
          </div>
        `;

        document.body.appendChild(notification);

        // Auto-remove after 8 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.style.animation = 'slideOutRight 0.5s ease-in';
            setTimeout(() => notification.remove(), 500);
          }
        }, 8000);

        // Clean up URL parameters
        const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);

        // Refresh page after a short delay to update user's plan status
        setTimeout(() => {
          window.location.reload();
        }, 3000);
      }
    };

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      window.paymentFlowManager.init();
      window.paymentFlowManager.checkPaymentSuccess();
    });
  </script>

  <!-- Stripe Integration for Payment Processing -->
  <script src="https://js.stripe.com/v3/"></script>
  <script>
      // Set Stripe publishable key for payment.js
      window.stripePublishableKey = '{{ config.STRIPE_PUBLISHABLE_KEY or "" }}';
  </script>
  <script src="{{ url_for('static', filename='js/payment.js') }}"></script>
  <script src="{{ url_for('static', filename='js/email-verification-modal.js') }}"></script>

  <!-- Device Compatibility - Load first for device detection -->
  <script src="{{ versioned_url_for('static', filename='js/device-compatibility.js') }}"></script>

  <!-- Performance Optimizer - Load early for mobile optimization -->
  <script src="{{ versioned_url_for('static', filename='js/performance-optimizer.js') }}"></script>

  <!-- Language Preferences System for Mobile UX -->
  <script src="{{ versioned_url_for('static', filename='js/language-preferences.js') }}"></script>

  <!-- Mobile Basic Mode Enhancements -->
  <script src="{{ versioned_url_for('static', filename='js/mobile-basic-mode.js') }}"></script>

  <!-- Mobile Navigation System -->
  <script src="{{ versioned_url_for('static', filename='mobile-nav.js') }}"></script>

  <!-- Mobile Icon Debugging Script -->
  <script>
    // Force mobile interface for testing
    function forceMobileInterface() {
      console.log('üîß Forcing mobile interface for testing...');

      // Hide stop button
      const stopBtn = document.getElementById('basic-stop-btn');
      if (stopBtn) {
        stopBtn.style.display = 'none';
        console.log('‚úÖ Stop button hidden');
      }

      // Initialize mobile basic mode if not already done
      if (window.mobileBasicMode) {
        window.mobileBasicMode.isMobile = true;
        window.mobileBasicMode.setupMobilePlaybackControls();
        window.mobileBasicMode.runMobileInterfaceTests();
      } else {
        console.log('‚ö†Ô∏è Mobile basic mode not loaded yet');
      }
    }

    // Test TTS pause/resume functionality
    function testTTSPauseResume() {
      console.log('üß™ Testing TTS pause/resume functionality...');

      // Add test text to transcript
      const transcriptEl = document.getElementById('basic-transcript');
      if (transcriptEl) {
        transcriptEl.value = 'This is a test of the Text-to-Speech pause and resume functionality. The audio should be able to pause at any point and resume from the exact same position without making a new API call.';
        console.log('‚úÖ Test text added to transcript');

        // Instructions for manual testing
        console.log('üìã Manual Test Instructions:');
        console.log('1. Click the play button to start TTS');
        console.log('2. Wait a few seconds, then click the play button again (should show pause icon) to pause');
        console.log('3. Click the play button again (should show play icon) to resume from the same position');
        console.log('4. Check that no new API call is made when resuming');
        console.log('5. Use debugTTSState("basic-transcript") to check audio state');
      } else {
        console.error('‚ùå Transcript element not found');
      }
    }

    // Debug mobile icon visibility issues
    function debugMobileIcons() {
      console.log('=== MOBILE ICON DEBUG ===');

      // Check if we're in mobile view
      const isMobile = window.innerWidth <= 768;
      console.log('Is mobile view:', isMobile);
      console.log('Window width:', window.innerWidth);

      // Check if basic mode is active
      const basicMode = document.getElementById('basic-mode');
      console.log('Basic mode element:', basicMode);
      console.log('Basic mode display:', basicMode ? getComputedStyle(basicMode).display : 'not found');

      // Check card header
      const cardHeader = document.querySelector('#basic-mode .card-header');
      console.log('Card header element:', cardHeader);
      console.log('Card header display:', cardHeader ? getComputedStyle(cardHeader).display : 'not found');

      // Check button container
      const buttonContainer = document.querySelector('#basic-mode .card-header .flex');
      console.log('Button container element:', buttonContainer);
      console.log('Button container display:', buttonContainer ? getComputedStyle(buttonContainer).display : 'not found');

      // Check individual buttons
      const buttons = ['basic-record-btn', 'basic-upload-btn', 'basic-play-btn', 'basic-stop-btn', 'basic-copy-btn'];
      buttons.forEach(id => {
        const btn = document.getElementById(id);
        console.log(`Button ${id}:`, btn);
        if (btn) {
          const styles = getComputedStyle(btn);
          console.log(`  Display: ${styles.display}`);
          console.log(`  Visibility: ${styles.visibility}`);
          console.log(`  Opacity: ${styles.opacity}`);

          // Check icon
          const icon = btn.querySelector('i');
          if (icon) {
            const iconStyles = getComputedStyle(icon);
            console.log(`  Icon display: ${iconStyles.display}`);
            console.log(`  Icon color: ${iconStyles.color}`);
            console.log(`  Icon font-family: ${iconStyles.fontFamily}`);
          } else {
            console.log('  No icon found!');
          }
        }
      });

      console.log('=== END DEBUG ===');
    }

    // Run debug on load and resize
    document.addEventListener('DOMContentLoaded', debugMobileIcons);
    window.addEventListener('resize', debugMobileIcons);

    // Force button visibility on mobile
    function forceMobileButtonVisibility() {
      if (window.innerWidth <= 768) {
        const buttons = document.querySelectorAll('#basic-mode .card-header .button, #basic-mode .card-header .header-record-button');
        buttons.forEach(btn => {
          btn.style.display = 'flex';
          btn.style.visibility = 'visible';
          btn.style.opacity = '1';

          const icon = btn.querySelector('i');
          if (icon) {
            icon.style.display = 'inline-block';
            icon.style.visibility = 'visible';
            icon.style.opacity = '1';
          }
        });

        const container = document.querySelector('#basic-mode .card-header .flex');
        if (container) {
          container.style.display = 'flex';
          container.style.visibility = 'visible';
          container.style.opacity = '1';
        }
      }
    }

    // Run force visibility
    document.addEventListener('DOMContentLoaded', forceMobileButtonVisibility);
    window.addEventListener('resize', forceMobileButtonVisibility);

    // Enhanced microphone icon function - ensures visibility and persistence
    function ensureMicrophoneIcon() {
      const recordBtn = document.getElementById('basic-record-btn');
      if (recordBtn) {
        // Check if icon already exists and is properly configured
        let icon = recordBtn.querySelector('i.fas.fa-microphone, i.fas');

        if (!icon) {
          // Only clear and recreate if no icon exists
          recordBtn.innerHTML = '';
          icon = document.createElement('i');
          icon.className = 'fas fa-microphone';
          recordBtn.appendChild(icon);
          console.log('Created new microphone icon');
        } else {
          // Update existing icon class if needed
          if (!icon.classList.contains('fa-microphone')) {
            icon.className = 'fas fa-microphone';
            console.log('Updated existing microphone icon class');
          }
        }

        // Get current theme
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';

        // Apply theme-appropriate styling - WHITE icon for blue button background
        const baseStyles = `
          font-family: "Font Awesome 6 Free", "Font Awesome 5 Free", FontAwesome !important;
          font-weight: 900 !important;
          font-style: normal !important;
          display: inline-block !important;
          opacity: 1 !important;
          visibility: visible !important;
          color: #ffffff !important;
          background-color: transparent !important;
          border-radius: 0 !important;
          padding: 0 !important;
          font-size: 16px !important;
          line-height: 1 !important;
          text-align: center !important;
          position: relative !important;
          z-index: 9999 !important;
        `;

        icon.style.cssText = baseStyles;

        // Force white color with additional specificity
        icon.style.setProperty('color', '#ffffff', 'important');

        // Add CSS class for additional specificity
        icon.classList.add('microphone-icon-override');

        console.log(`Microphone icon styled for ${currentTheme} theme`);
      }
    }

    // Run microphone icon fix on various events
    document.addEventListener('DOMContentLoaded', ensureMicrophoneIcon);
    window.addEventListener('load', ensureMicrophoneIcon);

    // Run after theme changes
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
          setTimeout(ensureMicrophoneIcon, 100);
        }
      });
    });
    observer.observe(document.documentElement, { attributes: true });

    // Also run after delays to catch any dynamic content
    setTimeout(ensureMicrophoneIcon, 1000);
    setTimeout(ensureMicrophoneIcon, 3000);
    setTimeout(ensureMicrophoneIcon, 5000);

    // Force icon fix every 2 seconds for the first 10 seconds to catch any interference
    let fixAttempts = 0;
    const forceFixInterval = setInterval(() => {
      ensureMicrophoneIcon();

      // Additional check: verify icon color is white
      const recordBtn = document.getElementById('basic-record-btn');
      if (recordBtn) {
        const icon = recordBtn.querySelector('i');
        if (icon) {
          const computedColor = getComputedStyle(icon).color;
          if (computedColor !== 'rgb(255, 255, 255)' && computedColor !== '#ffffff' && computedColor !== 'white') {
            console.log(`Microphone icon color is wrong: ${computedColor}, forcing white...`);
            icon.style.setProperty('color', '#ffffff', 'important');
            icon.classList.add('microphone-icon-override');
          }
        }
      }

      fixAttempts++;
      if (fixAttempts >= 5) {
        clearInterval(forceFixInterval);
      }
    }, 2000);

    // Add visibility observer to detect if icon becomes hidden
    function observeIconVisibility() {
      const recordBtn = document.getElementById('basic-record-btn');
      if (recordBtn) {
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'childList' || mutation.type === 'attributes') {
              // Check if icon is still present and visible
              const icon = recordBtn.querySelector('i');
              if (!icon || getComputedStyle(icon).opacity === '0' || getComputedStyle(icon).visibility === 'hidden') {
                console.log('Microphone icon visibility issue detected, fixing...');
                setTimeout(ensureMicrophoneIcon, 100);
              }
            }
          });
        });

        observer.observe(recordBtn, {
          childList: true,
          attributes: true,
          attributeFilter: ['style', 'class'],
          subtree: true
        });
      }
    }

    // Start observing after initial setup
    setTimeout(observeIconVisibility, 2000);
  </script>


</body>
</html>
